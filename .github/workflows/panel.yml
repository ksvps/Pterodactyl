name: Crafty Container Panel

on:
  workflow_dispatch:

jobs:
  minecraft:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      # Create docker-compose-playit.yml
      - name: Create Playit docker-compose file
        run: |
          cat <<'EOF' > docker-compose-playit.yml
          version: '3'

          services:
            playit:
              image: ghcr.io/playit-cloud/playit-agent:0.15
              network_mode: host
              environment:
                - SECRET_KEY=5bca7753854a8cd7e239f549150e65b523bc29c0d6051e492932b9ffb147b023
          EOF

      # Create docker-compose-panel.yml
      - name: Create Panel docker-compose file
        run: |
          cat <<'EOF' > docker-compose-panel.yml
          version: '3'

          services:
            crafty:
              container_name: crafty_container
              image: registry.gitlab.com/crafty-controller/crafty-4:latest
              restart: always
              environment:
                - TZ=Etc/UTC
              ports:
                - "8443:8443"       # HTTPS
                - "8123:8123"       # DYNMAP
                - "19132:19132/udp" # BEDROCK
                - "25500-25600:25500-25600" # MC SERV PORT RANGE
              volumes:
                - ./docker/backups:/crafty/backups
                - ./docker/logs:/crafty/logs
                - ./docker/servers:/crafty/servers
                - ./docker/config:/crafty/app/config
                - ./docker/import:/crafty/import
          EOF

      # Run Playit
      - name: Start Playit
        run: docker compose -f docker-compose-playit.yml up -d

      # Run Panel
      - name: Start Panel
        run: docker compose -f docker-compose-panel.yml up -d

      # Show running containers
      - name: Show running containers
        run: |
          docker ps -a
          sleep 20000
